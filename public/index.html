<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="./index.css">

    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script src="./js/control.js"></script>

    <title>WeathcerChart</title>
</head>
<body>
    <div class="section1">
        <form id = "location">
            <input type="text" id="city" name = "city" placeholder="input city">
            <button id="add">Add city</button>
        </form>
    </div>

    <div id = "citys"></div>
    <div class="section2">
        <canvas id="canvas" width="600px" height="380px"></canvas>
    </div>
    
</body>

<script>
    let data = {
        'Taipei':35,
        'Tokyo':20,
        'Paris':18
    }

    let chart = document.getElementById('canvas');
    let ctx = chart.getContext('2d');  
    let x = chart.width;
    let y = chart.height-30;
    let max_temp = 50;
    let min_temp = -40;
    let zero_yaxis;
    let temp_space = 10;
    let line_count = (max_temp-min_temp)/temp_space;
    let space_height = y/(line_count+1);
    let temp_height = y/(max_temp-min_temp+10);

    let initChart = () =>{
        ctx.clearRect(0, 0, x, chart.height);
        let y_axis = y;
        min_temp = -40;
        ctx.clearRect(0, 0, ctx.width, ctx.height);
        ctx.moveTo(30,5);
        ctx.lineTo(30,y);
        ctx.lineTo(x,y);

        while(y_axis!==0){
            if(min_temp==0){
                zero_yaxis = y_axis; 
            }
            ctx.font = "15px Arial";
            ctx.fillText(min_temp,0,y_axis);
            ctx.moveTo(30,y_axis);
            ctx.lineTo(x,y_axis);
            y_axis-=space_height;
            min_temp+=temp_space;
        }
        ctx.stroke();
    }



    let drawChart = () =>{
        initChart();
        let chart_data = Object.keys(data);
        let chart_width = x/chart_data.length;
        let center_width = chart_width/4;
        let x_begin = 30;
        chart_data.map((index)=>{
            let height = data[index]>0 ? -(data[index]*temp_height) : data[index]*temp_height;
            let color = parseInt(data[index], 16)*16;
            let text = index +" "+ data[index] + "Â°C";

            ctx.fillText(text,x_begin+center_width,chart.height-10);
            ctx.fillStyle=`#${color}`;
            ctx.fillRect(x_begin,zero_yaxis,chart_width,height);
            x_begin+=chart_width;
        })
    }

    drawChart();

    $("#location").submit(function(e){
        e.preventDefault();
        $.ajax({
            url : '/location',
            type: "POST",
            dataType: "json",
            data:$( "#location" ).serialize(),
            success: function(data) {
                let city = $( "#city").val();
                addData(data,city);
            },
            error:function(err){
                console.log(err)
            }
        })
    })

    let addData = (temp,city) =>{
        data[city] = temp
        drawChart();
    }
</script>

</html>